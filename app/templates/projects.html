{% extends "base.html" %}

{% block title %}Projects - gepesClassifier v1.1{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
<style>
    .projects-header {
        padding-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .user-info {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        background-color: var(--primary-bg-light);
        padding: 0.5rem 0.8rem;
        border-radius: 50rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .user-name {
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--primary-dark);
        display: flex;
        align-items: center;
        line-height: 1;
    }
    
    .user-name i {
        margin-right: 0.5rem;
        color: var(--primary-color);
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .header-btn {
        color: white;
        border: none;
        padding: 0.4rem 0.9rem;
        font-size: 0.85rem;
        border-radius: 50rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
    }
    
    .header-btn i {
        margin-right: 0.4rem;
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        line-height: 1;
    }
    
    .dashboard-btn {
        background-color: var(--primary-color);
        margin-right: 0.2rem;
    }
    
    .dashboard-btn:hover {
        background-color: var(--primary-dark);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(26, 99, 84, 0.3);
    }
    
    .logout-btn {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    }
    
    .logout-btn:hover {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(26, 99, 84, 0.4);
    }
    
    .header-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    
    /* Estilos para o container e linha de filtros */
    .filters-container {
        width: 100%;
        margin-bottom: 1.5rem;
    }
    
    .filters-row {
        display: flex;
        align-items: center;
        width: 100%;
        position: relative;
    }
    
    .projects-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .project-icon-container {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .project-icon {
        width: 52px;
        height: 52px;
        object-fit: contain;
        margin-top: 5px;
    }
    
    .titles-container {
        display: flex;
        flex-direction: column;
        padding-top: 0.1rem;
    }
    
    .projects-title {
        color: var(--primary-dark);
        font-weight: 700;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        letter-spacing: 0.5px;
        margin-bottom: -0.1rem;
    }
    
    .projects-title i {
        color: var(--primary-color);
    }
    
    .projects-subtitle {
        color: var(--text-muted);
        font-size: 1.05rem;
        font-weight: 500;
        margin-bottom: 0;
    }
    
    .version-badge, .project-count-badge {
        background-color: var(--primary-dark);
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        letter-spacing: 0.5px;
        margin-left: 0.75rem;
        vertical-align: top;
        background: linear-gradient(135deg, #029260, #1A6354);
        display: inline-flex;
        align-items: center;
    }
    
    .count-icon {
        margin-right: 4px;
        font-size: 0.7rem;
        color: white !important;
    }
    
    .search-container {
        position: relative;
        flex: 1;
        min-width: 200px;
    }
    
    .search-container i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
    }
    
    .search-input {
        border-radius: 10px;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid var(--input-border);
        background-color: var(--input-bg);
        transition: all 0.3s ease;
        width: 100%;
    }
    
    .search-input:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(53, 187, 159, 0.25);
    }
    
    .project-table-card {
        border-radius: 12px;
        overflow: hidden;
        border: solid 1px #ccc;
        transition: all 0.3s ease;
    }
    
    .project-table-card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    
    #projectsTable {
        margin-bottom: 0;
    }
    
    #projectsTable thead th {
        background-color: var(--primary-dark);
        color: white;
        font-weight: 600;
        padding: 1rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    #projectsTable tbody td {
        padding: 0.75rem 1rem;
        vertical-align: middle;
        border-bottom: 1px solid var(--card-border);
        white-space: nowrap;
    }
    
    /* Permitir quebra de linha na coluna de Área de Aplicação */
    #projectsTable tbody tr td:nth-child(6) {
        white-space: normal;
    }
    
    .project-title {
        font-weight: 300;
        color: var(--text-muted);
        font-size: 0.8rem;
        border-bottom: none;
        white-space: nowrap;
        max-width: 250px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        line-height: 1.2;
        padding: 0;
        position: relative;
    }
    
    .project-code {
        font-size: 0.8rem;
        color: var(--text-muted);
        white-space: nowrap;
        max-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        line-height: 1.2;
        padding: 0;
        margin-top: 0.1rem;
        position: relative;
    }
    
    /* Aumentar o limite de caracteres para a coluna de Área de Aplicação */
    #projectsTable tbody tr td:nth-child(6) .project-code {
        max-width: 250px; /* Reduzido para evitar barra de rolagem horizontal */
        white-space: normal; /* Permitir quebra de linha */
        text-overflow: clip; /* Não mostrar reticências */
    }
    
    /* Garantir que a coluna Tec Verde não tenha quebra de texto */
    #projectsTable tbody tr td:nth-child(7) {
        white-space: nowrap;
    }
    
    /* Garantir que o conteúdo da coluna Tec Verde não quebre */
    #projectsTable tbody tr td:nth-child(7) .project-code {
        white-space: nowrap;
    }
    
    .clickable-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .clickable-row:hover {
        background-color: var(--primary-bg-light);
    }
    
    .clickable-row:hover .project-title {
        color: var(--primary-color);
    }
    
    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: var(--text-muted);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* Estilos para o infinite scroll */
    .loading-more {
        text-align: center;
        padding: 1.5rem;
        color: var(--text-muted);
        display: none;
    }
    
    .loading-more i {
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    #end-of-results {
        text-align: center;
        padding: 1.5rem;
        color: var(--text-muted);
        font-style: italic;
        display: none;
    }
    
    /* Alternância de cores nas linhas */
    #projectsTable tbody tr:nth-child(even) {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    /* Estilos para o filtro */
    .filter-container {
        position: relative;
        width: 220px;
        margin-right: 1rem;
    }
    
    .filter-container i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
    }
    
    .filter-select {
        border-radius: 10px;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid var(--input-border);
        background-color: var(--input-bg);
        transition: all 0.3s ease;
        width: 100%;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 16px 12px;
    }
    
    .filter-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(53, 187, 159, 0.25);
    }
    
    /* Estilos para os tooltips */
    .tooltip-inner {
        max-width: 300px;
        padding: 0.5rem 0.75rem;
        text-align: left;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .tooltip.show {
        opacity: 1;
    }
    
    /* Estilo para a célula do código do projeto */
    .copy-code-cell {
        cursor: copy !important;
        position: relative;
    }
    
    /* Estilo para o tooltip de copiado */
    .copy-tooltip {
        position: absolute;
        background-color: var(--primary-dark);
        color: white;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        top: -25px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        animation: fadeIn 0.2s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* Estilos dos badges de status */
    .badge.rounded-pill {
        font-size: 0.8rem;
        font-weight: 500;
        padding: 0.3rem 0.8rem;
        letter-spacing: 0.5px;
    }
    
    .badge.bg-warning {
        background-color: #ffc107 !important;
        color: #212529;
    }
    
    .badge.bg-info {
        background-color: #0d6efd !important;
        color: white;
    }
    
    .badge.bg-success {
        background-color: #198754 !important;
        color: white;
    }
    
    /* Estilos para o overlay de carregamento da tabela */
    .table-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        border-radius: 12px;
        display: none;
    }
    
    .loading-spinner {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: var(--primary-dark);
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .loading-spinner i {
        font-size: 2rem;
        margin-bottom: 0.75rem;
        animation: spin 1s linear infinite;
    }
    
    .loading-text {
        font-size: 1rem;
        font-weight: 500;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="projects-header">
    <div class="projects-info">
        <div class="project-icon-container">
            <img src="{{ url_for('static', filename='img/ai.png') }}" alt="Ícone de Projetos" class="project-icon">
        </div>
        <div class="titles-container">
            <h2 class="projects-title">
                gepesClassifier
                <span class="version-badge">v1.1</span>
                <span class="project-count-badge">
                    <i class="fas fa-folder count-icon"></i>
                    {{ "{:,}".format(total_projects).replace(',', '.') }}
                </span>
                <input type="hidden" id="totalProjectsCount" value="{{ total_projects }}">
            </h2>
            <p class="projects-subtitle">
                Classificador de projetos Embrapii
            </p>
        </div>
    </div>
    <div class="user-info">
        <a href="{{ url_for('dashboard.index') }}" class="header-btn dashboard-btn">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="{{ url_for('main.logout') }}" class="header-btn logout-btn">
            <i class="fas fa-sign-out-alt"></i> Sair
        </a>
    </div>
</div>

<!-- Filtros abaixo do header -->
<div class="filters-container">
  <div class="filters-row">
    <div class="filter-container">
        <i class="fas fa-filter"></i>
        <select id="categoryFilter" class="form-control filter-select">
            <option value="all">Todos os projetos</option>
            <option value="uncategorized">Não Classificado</option>
            <option value="ai_classified">Classificado por IA</option>
            <option value="human_validated">Validado por Humano</option>
        </select>
    </div>
    <div class="filter-container">
        <i class="fas fa-leaf"></i>
        <select id="tecVerdeFilter" class="form-control filter-select">
            <option value="all">Todas</option>
            <option value="sim">Sim</option>
            <option value="nao">Não</option>
            {% if tecverde_classes %}
                <optgroup label="Classes">
                    {% for classe, descricao in tecverde_classes.items() %}
                    <option value="classe:{{ classe }}">{{ classe }}</option>
                    {% endfor %}
                </optgroup>
                <optgroup label="Subclasses">
                    {% for classe, subclasses in tecverde_subclasses.items() %}
                        {% if subclasses %}
                            {% set subclasses_list = subclasses.split(';') if ';' in subclasses else subclasses.split(',') if ',' in subclasses else [subclasses] %}
                            {% for subclasse in subclasses_list %}
                                {% set subclasse_clean = subclasse.strip() %}
                                {% if subclasse_clean %}
                                <option value="subclasse:{{ subclasse_clean }}">{{ subclasse_clean }}</option>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </optgroup>
            {% endif %}
        </select>
    </div>
    <div class="search-container">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" class="form-control search-input" placeholder="Buscar projeto...">
    </div>
  </div>
</div>

<!-- Elemento oculto para armazenar dados de paginação -->
<div id="pagination-data" 
     data-current-page="{{ pagination.page }}" 
     data-has-next="{{ 'true' if has_next else 'false' }}" 
     data-next-page="{{ next_page if next_page else '' }}"
     style="display: none;">
</div>

<div class="loading-more">
    <i class="fas fa-spinner"></i> Carregando mais projetos...
</div>
<div id="end-of-results">
    Todos os projetos foram carregados.
</div>

<div class="card project-table-card position-relative">
    <!-- Overlay de carregamento para filtragem e carregamento de projetos -->
    <div class="table-loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner"></i>
            <span class="loading-text">Carregando projetos...</span>
        </div>
    </div>
    <div class="table-responsive" style="overflow-x: auto; width: 100%;">
        <table class="table" id="projectsTable" style="width: auto; min-width: 100%;">
            <thead>
                <tr>
                    <th style="min-width: 150px;">Código</th>
                    <th style="min-width: 100px;">Status</th>
                    <th style="min-width: 80px;">UE</th>
                    <th style="min-width: 100px;">Data</th>
                <th style="min-width: 250px;">Título do Projeto</th>
                <th style="min-width: 250px;">Área de Aplicação</th>
                <th style="min-width: 80px;">Tec Verde</th>
                </tr>
            </thead>
            <tbody>
                {% if projects %}
                    {% for project in projects %}
                    <tr class="clickable-row" data-href="/categorize/{{ project.codigo_projeto }}">
                        <td class="copy-code-cell" data-code="{{ project.codigo_projeto }}">
                            {% if project.codigo_projeto %}
                            <span class="project-code">{{ project.codigo_projeto }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if project.human_validated %}
                                <span class="badge bg-success rounded-pill">Validado por Humano</span>
                            {% elif project.ai_classified %}
                                <span class="badge bg-info rounded-pill">Classificado por IA</span>
                            {% else %}
                                <span class="badge bg-warning rounded-pill">Não Classificado</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if project.unidade_embrapii %}
                            <span class="project-code" data-bs-toggle="tooltip" title="{{ project.unidade_embrapii }}">{{ project.unidade_embrapii }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if project.data_contrato %}
                            <span class="project-code data-contrato" data-timestamp="{{ project.data_contrato }}">{{ project.data_contrato }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="project-title" data-bs-toggle="tooltip" title="{{ project.titulo }}">{{ project.titulo }}</span>
                        </td>
                        <td>
                            {% if project._aia_n1_macroarea or project._aia_n2_segmento %}
                                {% if project.additional_classifications is defined and project.additional_classifications %}
                                <span class="project-code" data-bs-toggle="tooltip" data-bs-html="true" 
                                      title="<div class='text-start'><strong>Classificações adicionais:</strong>
                                             {% for cls in project.additional_classifications %}
                                             <div class='mt-2 mb-1'><strong>{{ loop.index }}.</strong> {{ cls.microarea|default('') }} / {{ cls.segmento|default('') }}</div>
                                             {% endfor %}</div>">
                                    {% if project._aia_n1_macroarea and project._aia_n2_segmento %}
                                        {{ project._aia_n1_macroarea }}, {{ project._aia_n2_segmento }}
                                    {% elif project._aia_n1_macroarea %}
                                        {{ project._aia_n1_macroarea }}
                                    {% elif project._aia_n2_segmento %}
                                        {{ project._aia_n2_segmento }}
                                    {% endif %}
                                </span>
                                {% else %}
                                <span class="project-code">
                                    {% if project._aia_n1_macroarea and project._aia_n2_segmento %}
                                        {{ project._aia_n1_macroarea }}, {{ project._aia_n2_segmento }}
                                    {% elif project._aia_n1_macroarea %}
                                        {{ project._aia_n1_macroarea }}
                                    {% elif project._aia_n2_segmento %}
                                        {{ project._aia_n2_segmento }}
                                    {% endif %}
                                </span>
                                {% endif %}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if project.tecverde_se_aplica is defined and project.tecverde_se_aplica == "1" %}
                                {% if project.tecverde_classe and project.tecverde_subclasse %}
                                <span class="project-code" data-bs-toggle="tooltip" data-bs-html="true" 
                                      title="<div class='text-start'><strong>Classe:</strong> {{ project.tecverde_classe }}<br><strong>Subclasse:</strong> {{ project.tecverde_subclasse }}</div>">
                                    Sim
                                </span>
                                {% else %}
                                <span class="project-code">Sim</span>
                                {% endif %}
                            {% elif project.tecverde_se_aplica is defined and project.tecverde_se_aplica == "0" %}
                                <span class="project-code">Não</span>
                            {% elif project.tecverde_se_aplica is defined and project.tecverde_se_aplica == 1 %}
                                {% if project.tecverde_classe and project.tecverde_subclasse %}
                                <span class="project-code" data-bs-toggle="tooltip" data-bs-html="true" 
                                      title="<div class='text-start'><strong>Classe:</strong> {{ project.tecverde_classe }}<br><strong>Subclasse:</strong> {{ project.tecverde_subclasse }}</div>">
                                    Sim
                                </span>
                                {% else %}
                                <span class="project-code">Sim</span>
                                {% endif %}
                {% else %}
                    {% set has_ai_suggestion = false %}
                    {% set ai_suggestion_value = 0 %}
                    {% set ai_suggestion_class = "" %}
                    {% set ai_suggestion_subclass = "" %}
                    
                    {% for suggestion in ai_suggestions if suggestion.project_id == project.id %}
                                    {% set has_ai_suggestion = true %}
                                    {% set ai_suggestion_value = suggestion.tecverde_se_aplica %}
                                    {% set ai_suggestion_class = suggestion.tecverde_classe %}
                                    {% set ai_suggestion_subclass = suggestion.tecverde_subclasse %}
                                {% endfor %}
                                
                                {% if has_ai_suggestion and ai_suggestion_value == True %}
                                    {% if ai_suggestion_class and ai_suggestion_subclass %}
                                    <span class="project-code" data-bs-toggle="tooltip" data-bs-html="true" 
                                          title="<div class='text-start'><strong>Classe:</strong> {{ ai_suggestion_class }}<br><strong>Subclasse:</strong> {{ ai_suggestion_subclass }}<br><em>(Sugerido por IA)</em></div>">
                                        Sim
                                    </span>
                                    {% else %}
                                    <span class="project-code">Sim</span>
                                    {% endif %}
                                {% else %}
                                    <span class="project-code">Não</span>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <p>Nenhum projeto encontrado</p>
                                <button class="btn btn-gradient rounded-pill mt-2">
                                    <i class="fas fa-plus me-1"></i> Novo Projeto
                                </button>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    // Função para formatar timestamp para data no formato brasileiro (dd/mm/aaaa)
    function formatarDataBrasileira(timestamp) {
        // Verificar se o timestamp é válido
        if (!timestamp || isNaN(timestamp)) {
            return "-";
        }
        
        // Converter para número se for string
        if (typeof timestamp === 'string') {
            timestamp = parseInt(timestamp);
        }
        
        // Criar objeto de data
        const data = new Date(timestamp);
        
        // Verificar se a data é válida
        if (isNaN(data.getTime())) {
            return "-";
        }
        
        // Formatar para dd/mm/aaaa
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0'); // Mês começa em 0
        const ano = data.getFullYear();
        
        return `${dia}/${mes}/${ano}`;
    }

    $(document).ready(function() {
        // Ordenar os projetos iniciais por status
        (function sortInitialProjects() {
            // Obter todas as linhas da tabela
            var rows = $("#projectsTable tbody tr.clickable-row").toArray();
            
            // Ordenar as linhas com base no texto do badge de status
            rows.sort(function(a, b) {
                var statusA = $(a).find(".badge").first().text();
                var statusB = $(b).find(".badge").first().text();
                
                // Definir a ordem de prioridade dos status
                const statusOrder = {
                    "Não Classificado": 1,
                    "Classificado por IA": 2,
                    "Validado por Humano": 3
                };
                
                return statusOrder[statusA] - statusOrder[statusB];
            });
            
            // Reordenar as linhas na tabela
            $.each(rows, function(index, row) {
                $("#projectsTable tbody").append(row);
            });
        })();
        
        // Verificar se há filtros na URL e aplicá-los
        (function applyUrlFilters() {
            // Obter parâmetros da URL
            var urlParams = new URLSearchParams(window.location.search);
            var hasFilters = false;
            
            // Aplicar filtro de categoria se presente na URL
            if (urlParams.has('filter')) {
                var filterValue = urlParams.get('filter');
                if (filterValue && filterValue !== 'all') {
                    $("#categoryFilter").val(filterValue);
                    hasFilters = true;
                }
            }
            
            // Aplicar filtro de tecverde se presente na URL
            if (urlParams.has('tecverde')) {
                var tecverdeValue = urlParams.get('tecverde');
                if (tecverdeValue && tecverdeValue !== 'all') {
                    $("#tecVerdeFilter").val(tecverdeValue);
                    hasFilters = true;
                }
            }
            
            // Aplicar filtro de busca se presente na URL
            if (urlParams.has('search')) {
                var searchValue = urlParams.get('search');
                if (searchValue) {
                    $("#searchInput").val(searchValue);
                    hasFilters = true;
                }
            }
            
            // Se há filtros na URL, atualizar o contador com o total filtrado
            if (hasFilters) {
                // O total já está correto pois o backend aplicou os filtros
                var totalFiltered = parseInt($("#totalProjectsCount").val());
                updateProjectCountBadge(totalFiltered);
            }
        })();
        
        // Armazenar o total de projetos em uma variável
        var totalProjects = parseInt($("#totalProjectsCount").val());
        
        // Inicializar tooltips do Bootstrap com opções personalizadas
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                placement: 'top',
                trigger: 'hover',
                html: true,
                container: 'body',
                boundary: 'window'
            });
        });
        
        // Formatar as datas de contrato
        $('.data-contrato').each(function() {
            const timestamp = $(this).data('timestamp');
            $(this).text(formatarDataBrasileira(timestamp));
        });
        
        // Limpar o localStorage relacionado ao overlay de carregamento ao carregar a página de projetos
        localStorage.removeItem('aiLoadingActive');
        localStorage.removeItem('aiLoadingMessage');
        localStorage.removeItem('aiLoadingSubmessage');
        
        // Esconder o overlay de carregamento se estiver visível
        if (typeof aiLoading !== 'undefined') {
            aiLoading.completeProgress();
        }
        
        // Função para filtrar projetos por texto
        $("#searchInput").on("keyup", function() {
            // Usar debounce para evitar muitas requisições
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                // Resetar paginação e recarregar projetos
                resetAndReload();
            }, 500);
        });
        
        // Função para filtrar por categorização e tec verde
        $("#categoryFilter, #tecVerdeFilter").on("change", function() {
            // Resetar paginação e recarregar projetos
            resetAndReload();
        });
        
        // Função para resetar paginação e recarregar projetos
        function resetAndReload() {
            // Mostrar overlay de carregamento
            $('.table-loading-overlay').fadeIn(200);
            
            // Limpar a tabela
            $("#projectsTable tbody").empty();
            
            // Resetar variáveis de paginação
            currentPage = 1;
            hasNextPage = true;
            nextPage = 1;
            
            // Esconder mensagem de fim de resultados
            $('#end-of-results').hide();
            
            // Carregar projetos com os novos filtros
            loadMoreProjects();
        }
        
        // Função para aplicar todos os filtros ativos
        function applyFilters() {
            // Obter valor do filtro de texto
            var textValue = $("#searchInput").val().toLowerCase();
            
            // Obter filtro de categorização selecionado
            var categorizationFilter = $("#categoryFilter").val();
            
            // Obter filtro de Tec Verde selecionado
            var tecVerdeFilter = $("#tecVerdeFilter").val();
            
            // Contar projetos visíveis antes da filtragem
            var totalVisibleBefore = $("#projectsTable tbody tr:visible").not("#noResults").length;
            console.log("Projetos visíveis antes da filtragem:", totalVisibleBefore);
            
            // Aplicar filtros combinados
            $("#projectsTable tbody tr").not("#noResults").each(function() {
                var row = $(this);
                var textMatch = row.text().toLowerCase().indexOf(textValue) > -1;
                var categorizationMatch = true;
                var tecVerdeMatch = true;
                
                // Verificar filtro de categorização diretamente pelo texto do badge
                if (categorizationFilter !== "all") {
                    var badgeText = row.find(".badge").first().text();
                    
                    if (categorizationFilter === "uncategorized") {
                        categorizationMatch = badgeText === "Não Classificado";
                    } else if (categorizationFilter === "ai_classified") {
                        categorizationMatch = badgeText === "Classificado por IA";
                    } else if (categorizationFilter === "human_validated") {
                        categorizationMatch = badgeText === "Validado por Humano";
                    }
                }
                
                // Verificar filtro de Tec Verde
                if (tecVerdeFilter !== "all") {
                    // Obter a célula Tec Verde (7ª coluna)
                    var tecVerdeCell = row.find("td:nth-child(7)");
                    var isTecVerde = false;
                    var tecVerdeClasse = "";
                    var tecVerdeSubclasse = "";
                    
                    // Verificar se a célula contém "Sim" - isso indica que tecverde_se_aplica é true
                    if (tecVerdeCell.find(".project-code").text().trim() === "Sim") {
                        isTecVerde = true;
                        
                        // Extrair classe e subclasse do tooltip se disponível
                        var tooltipTitle = tecVerdeCell.find("[data-bs-toggle='tooltip']").attr("title");
                        if (tooltipTitle) {
                            // Extrair classe do tooltip
                            var classeMatch = tooltipTitle.match(/<strong>Classe:<\/strong>\s*([^<]+)/);
                            if (classeMatch && classeMatch[1]) {
                                tecVerdeClasse = classeMatch[1].trim();
                            }
                            
                            // Extrair subclasse do tooltip
                            var subclasseMatch = tooltipTitle.match(/<strong>Subclasse:<\/strong>\s*([^<]+)/);
                            if (subclasseMatch && subclasseMatch[1]) {
                                tecVerdeSubclasse = subclasseMatch[1].trim();
                            }
                        }
                    }
                    
                    // Aplicar o filtro baseado no valor selecionado
                    if (tecVerdeFilter === "sim") {
                        tecVerdeMatch = isTecVerde === true;
                    } else if (tecVerdeFilter === "nao") {
                        tecVerdeMatch = isTecVerde === false;
                    } else if (tecVerdeFilter.startsWith("classe:")) {
                        // Filtrar por classe específica
                        var classeFilter = tecVerdeFilter.substring(7); // Remove "classe:"
                        tecVerdeMatch = isTecVerde && tecVerdeClasse === classeFilter;
                    } else if (tecVerdeFilter.startsWith("subclasse:")) {
                        // Filtrar por subclasse específica
                        var subclasseFilter = tecVerdeFilter.substring(10); // Remove "subclasse:"
                        tecVerdeMatch = isTecVerde && tecVerdeSubclasse === subclasseFilter;
                    }
                }
                
                // Mostrar ou esconder linha com base nos filtros combinados
                var shouldShow = textMatch && categorizationMatch && tecVerdeMatch;
                row.toggle(shouldShow);
            });
            
            // Contar projetos visíveis após a filtragem
            var totalVisibleAfter = $("#projectsTable tbody tr:visible").not("#noResults").length;
            console.log("Projetos visíveis após a filtragem:", totalVisibleAfter);
            
            // Atualizar contador de projetos visíveis
            updateProjectCount();
            
            // Verificar se há resultados
            checkNoResults(textValue);
        }
        
        // Função para atualizar o badge de contagem de projetos com o total filtrado
        function updateProjectCountBadge(count) {
            $(".project-count-badge").html('<i class="fas fa-folder count-icon"></i> ' + count.toLocaleString('pt-BR').replace(',', '.'));
        }
        
        // Função para atualizar o contador de projetos (mantida para compatibilidade)
        function updateProjectCount() {
            // Esta função agora não faz nada, pois o contador é atualizado com o total filtrado do servidor
            // Mantida para compatibilidade com o código existente
        }
        
        // Função para verificar se não há resultados e mostrar mensagem
        function checkNoResults(searchValue) {
            var visibleRows = $("#projectsTable tbody tr:visible").not("#noResults").length;
            if (visibleRows === 0) {
                // Adicionar mensagem de nenhum resultado
                if ($("#noResults").length === 0) {
                    var message = searchValue ? 
                        'Nenhum resultado encontrado para "' + searchValue + '"' : 
                        'Nenhum projeto encontrado com os filtros selecionados';
                    
                    $("#projectsTable tbody").append(
                        '<tr id="noResults"><td colspan="7">' +
                        '<div class="empty-state">' +
                        '<i class="fas fa-search"></i>' +
                        '<p>' + message + '</p>' +
                        '</div></td></tr>'
                    );
                } else {
                    // Atualizar mensagem existente
                    var message = searchValue ? 
                        'Nenhum resultado encontrado para "' + searchValue + '"' : 
                        'Nenhum projeto encontrado com os filtros selecionados';
                    
                    $("#noResults td div p").text(message);
                }
            } else {
                // Remover mensagem se houver resultados
                $("#noResults").remove();
            }
        }
        
        // Função para copiar o código do projeto ao clicar na primeira coluna
        $(".copy-code-cell").click(function(e) {
            e.stopPropagation(); // Impedir que o evento seja propagado para a linha
            
            const code = $(this).data("code");
            if (code) {
                // Copiar o código para a área de transferência
                navigator.clipboard.writeText(code).then(function() {
                    // Criar e mostrar o tooltip de confirmação
                    const cell = $(e.currentTarget);
                    
                    // Verificar se o tooltip já existe
                    if (cell.find(".copy-tooltip").length === 0) {
                        cell.append('<div class="copy-tooltip"><i class="fas fa-check"></i> Copiado!</div>');
                        
                        // Remover o tooltip após 2 segundos
                        setTimeout(function() {
                            cell.find(".copy-tooltip").fadeOut(200, function() {
                                $(this).remove();
                            });
                        }, 2000);
                    }
                }).catch(function(err) {
                    console.error('Erro ao copiar texto: ', err);
                });
            }
        });
        
        // Variáveis para o infinite scroll
        var currentPage = 1;
        var hasNextPage = false;
        var nextPage = null;
        var isLoading = false;
        var searchTimeout;
        
        // Inicializar valores de paginação a partir de atributos de dados
        if ($("#pagination-data").length) {
            currentPage = parseInt($("#pagination-data").data("current-page") || 1);
            hasNextPage = $("#pagination-data").data("has-next") === true;
            nextPage = $("#pagination-data").data("next-page") || null;
        }
        
        // Função para inicializar eventos de clique em linhas da tabela
        function initClickableRows() {
            // Função para tornar as linhas clicáveis (modificado para ignorar a primeira coluna)
            $(".clickable-row").off('click').on('click', function(e) {
                // Se o clique foi na primeira coluna, não redirecionar
                if ($(e.target).closest(".copy-code-cell").length > 0) {
                    return;
                }
                
                // Verificar o status do projeto diretamente pelo texto do badge
                var badgeText = $(this).find(".badge").first().text();
                var isHumanValidated = badgeText === "Validado por Humano";
                var isAIClassified = badgeText === "Classificado por IA";
                
                // Mostrar o overlay de carregamento antes de redirecionar
                if (typeof aiLoading !== 'undefined') {
                    if (isHumanValidated) {
                        // Mensagem para projetos validados por humano
                        aiLoading.show(
                            "Carregando projeto...", 
                            "Abrindo projeto com classificação validada por humano"
                        );
                    } else if (isAIClassified) {
                        // Mensagem para projetos classificados por IA
                        aiLoading.show(
                            "Carregando projeto...", 
                            "Abrindo projeto com classificação gerada pela IA"
                        );
                    } else {
                        // Mensagem para projetos não classificados
                        aiLoading.show(
                            "Carregando projeto...", 
                            "Aguarde enquanto a IA analisa e prepara as sugestões de classificação"
                        );
                    }
                }
                
                // Redirecionar após um pequeno delay para garantir que o overlay seja exibido
                setTimeout(() => {
                    window.location = $(this).data("href");
                }, 100);
            });
            
            // Reinicializar eventos de cópia de código
            $(".copy-code-cell").off('click').on('click', function(e) {
                e.stopPropagation(); // Impedir que o evento seja propagado para a linha
                
                const code = $(this).data("code");
                if (code) {
                    // Copiar o código para a área de transferência
                    navigator.clipboard.writeText(code).then(function() {
                        // Criar e mostrar o tooltip de confirmação
                        const cell = $(e.currentTarget);
                        
                        // Verificar se o tooltip já existe
                        if (cell.find(".copy-tooltip").length === 0) {
                            cell.append('<div class="copy-tooltip"><i class="fas fa-check"></i> Copiado!</div>');
                            
                            // Remover o tooltip após 2 segundos
                            setTimeout(function() {
                                cell.find(".copy-tooltip").fadeOut(200, function() {
                                    $(this).remove();
                                });
                            }, 2000);
                        }
                    }).catch(function(err) {
                        console.error('Erro ao copiar texto: ', err);
                    });
                }
            });
            
            // Reinicializar tooltips para novos elementos
            var newTooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]:not(.tooltip-initialized)'));
            newTooltipTriggerList.forEach(function(tooltipTriggerEl) {
                tooltipTriggerEl.classList.add('tooltip-initialized');
                new bootstrap.Tooltip(tooltipTriggerEl, {
                    placement: 'top',
                    trigger: 'hover',
                    html: true,
                    container: 'body',
                    boundary: 'window'
                });
            });
            
            // Formatar as datas de contrato para novos elementos
            $('.data-contrato:not(.formatted)').each(function() {
                const timestamp = $(this).data('timestamp');
                $(this).text(formatarDataBrasileira(timestamp));
                $(this).addClass('formatted');
            });
        }
        
        // Função para carregar mais projetos
        function loadMoreProjects() {
            if (isLoading || !hasNextPage && nextPage !== 1) return;
            
            isLoading = true;
            
            // Mostrar indicadores de carregamento
            if (nextPage === 1) {
                // Se for a primeira página, mostrar o overlay principal
                $('.table-loading-overlay').fadeIn(200);
            } else {
                // Se for carregamento de mais projetos, mostrar o indicador de "carregando mais"
                $('.loading-more').show();
            }
            
            // Obter parâmetros de filtro atuais
            var searchValue = $("#searchInput").val();
            var filterValue = $("#categoryFilter").val();
            var tecVerdeValue = $("#tecVerdeFilter").val();
            
            console.log("Carregando projetos com filtros:", {
                search: searchValue,
                filter: filterValue,
                tecverde: tecVerdeValue
            });
            
            // Fazer requisição AJAX para obter mais projetos
            $.ajax({
                url: '/projects',
                type: 'GET',
                data: {
                    page: nextPage || 1,
                    search: searchValue,
                    filter: filterValue,
                    tecverde: tecVerdeValue,
                    ajax: 1
                },
                dataType: 'json',
                success: function(data) {
                    // Esconder indicadores de carregamento
                    $('.loading-more').hide();
                    $('.table-loading-overlay').fadeOut(200);
                    
                    if (data.projects && data.projects.length > 0) {
                        // Adicionar novos projetos à tabela
                        appendProjects(data.projects);
                        
                        // Atualizar variáveis de paginação
                        currentPage = data.next_page ? data.next_page - 1 : currentPage + 1;
                        hasNextPage = data.has_next;
                        nextPage = data.next_page;
                        
                        // Atualizar o contador de projetos com o total filtrado
                        if (data.total !== undefined) {
                            updateProjectCountBadge(data.total);
                        }
                        
                        // Inicializar eventos para as novas linhas
                        initClickableRows();
                        
                        // Aplicar filtros aos novos projetos
                        applyFilters();
                    } else {
                        // Não há mais projetos para carregar
                        hasNextPage = false;
                        $('#end-of-results').show();
                    }
                    
                    isLoading = false;
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao carregar mais projetos:', error);
                    
                    // Esconder indicadores de carregamento em caso de erro
                    $('.loading-more').hide();
                    $('.table-loading-overlay').fadeOut(200);
                    
                    isLoading = false;
                }
            });
        }
        
    // Função para ordenar projetos por status
    function sortProjectsByStatus(projects) {
        // Definir a ordem de prioridade dos status
        const statusOrder = {
            "Não Classificado": 1,
            "Classificado por IA": 2,
            "Validado por Humano": 3
        };
        
        // Criar uma cópia do array para não modificar o original
        return [...projects].sort(function(a, b) {
            // Determinar o status de cada projeto
            const statusA = a.human_validated ? "Validado por Humano" : (a.ai_classified ? "Classificado por IA" : "Não Classificado");
            const statusB = b.human_validated ? "Validado por Humano" : (b.ai_classified ? "Classificado por IA" : "Não Classificado");
            
            // Comparar baseado na ordem definida
            return statusOrder[statusA] - statusOrder[statusB];
        });
    }
    
    // Função para adicionar projetos à tabela
    function appendProjects(projects) {
        var tbody = $("#projectsTable tbody");
        
        // Ordenar projetos por status antes de adicionar à tabela
        const sortedProjects = sortProjectsByStatus(projects);
        
        sortedProjects.forEach(function(project) {
                var row = $('<tr class="clickable-row"></tr>');
                row.attr('data-href', '/categorize/' + project.codigo_projeto);
                
                // Coluna do código do projeto
                var codeCell = $('<td class="copy-code-cell"></td>');
                codeCell.attr('data-code', project.codigo_projeto);
                if (project.codigo_projeto) {
                    codeCell.append('<span class="project-code">' + project.codigo_projeto + '</span>');
                } else {
                    codeCell.append('<span class="text-muted">-</span>');
                }
                row.append(codeCell);
                
                // Coluna de status
                var statusCell = $('<td></td>');
                if (project.human_validated) {
                    statusCell.append('<span class="badge bg-success rounded-pill">Validado por Humano</span>');
                } else if (project.ai_classified) {
                    statusCell.append('<span class="badge bg-info rounded-pill">Classificado por IA</span>');
                } else {
                    statusCell.append('<span class="badge bg-warning rounded-pill">Não Classificado</span>');
                }
                row.append(statusCell);
                
                // Coluna UE
                var ueCell = $('<td></td>');
                if (project.unidade_embrapii) {
                    var ueSpan = $('<span class="project-code"></span>');
                    ueSpan.attr('data-bs-toggle', 'tooltip');
                    ueSpan.attr('title', project.unidade_embrapii);
                    ueSpan.text(project.unidade_embrapii);
                    ueCell.append(ueSpan);
                } else {
                    ueCell.append('<span class="text-muted">-</span>');
                }
                row.append(ueCell);
                
                // Coluna Data
                var dateCell = $('<td></td>');
                if (project.data_contrato) {
                    var dateSpan = $('<span class="project-code data-contrato"></span>');
                    dateSpan.attr('data-timestamp', project.data_contrato);
                    dateSpan.text(project.data_contrato);
                    dateCell.append(dateSpan);
                } else {
                    dateCell.append('<span class="text-muted">-</span>');
                }
                row.append(dateCell);
                
                // Coluna Título
                var titleCell = $('<td></td>');
                var titleSpan = $('<span class="project-title"></span>');
                titleSpan.attr('data-bs-toggle', 'tooltip');
                titleSpan.attr('title', project.titulo);
                titleSpan.text(project.titulo);
                titleCell.append(titleSpan);
                row.append(titleCell);
                
                // Coluna Área de Aplicação
                var areaCell = $('<td></td>');
                if (project._aia_n1_macroarea || project._aia_n2_segmento) {
                    var areaText = '';
                    if (project._aia_n1_macroarea && project._aia_n2_segmento) {
                        areaText = project._aia_n1_macroarea + ', ' + project._aia_n2_segmento;
                    } else if (project._aia_n1_macroarea) {
                        areaText = project._aia_n1_macroarea;
                    } else if (project._aia_n2_segmento) {
                        areaText = project._aia_n2_segmento;
                    }
                    areaCell.append('<span class="project-code">' + areaText + '</span>');
                } else {
                    areaCell.append('<span class="text-muted">-</span>');
                }
                row.append(areaCell);
                
                // Coluna Tec Verde
                var tecVerdeCell = $('<td></td>');
                if (project.tecverde_se_aplica === "1" || project.tecverde_se_aplica === 1 || project.tecverde_se_aplica === true) {
                    if (project.tecverde_classe && project.tecverde_subclasse) {
                        var tecVerdeSpan = $('<span class="project-code"></span>');
                        tecVerdeSpan.attr('data-bs-toggle', 'tooltip');
                        tecVerdeSpan.attr('data-bs-html', 'true');
                        tecVerdeSpan.attr('title', "<div class='text-start'><strong>Classe:</strong> " + project.tecverde_classe + "<br><strong>Subclasse:</strong> " + project.tecverde_subclasse + "</div>");
                        tecVerdeSpan.text('Sim');
                        tecVerdeCell.append(tecVerdeSpan);
                    } else {
                        tecVerdeCell.append('<span class="project-code">Sim</span>');
                    }
                } else {
                    tecVerdeCell.append('<span class="project-code">Não</span>');
                }
                row.append(tecVerdeCell);
                
                // Adicionar a linha à tabela
                tbody.append(row);
            });
        }
        
        // Detectar quando o usuário rola até o final da página
        $(window).scroll(function() {
            if ($(window).scrollTop() + $(window).height() > $(document).height() - 200) {
                loadMoreProjects();
            }
        });
        
        // Inicializar eventos de clique para as linhas iniciais
        initClickableRows();
    });
</script>
{% endblock %}
